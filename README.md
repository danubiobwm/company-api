Company API

This repository contains an implementation of a Company API (Go + Gin + GORM + PostgreSQL)
for managing Colaboradores (employees) and Departamentos (departments). This README
explains how to build, run and test the project, how to generate the Swagger documentation,
and contains the list of endpoints and example requests (also provided in rest.http).

Prerequisites
-------------
- Docker & Docker Compose
- Go 1.22+ (only needed for local development/debug)
- swag CLI (optional, required if you need to regenerate docs): `go install github.com/swaggo/swag/cmd/swag@latest`

Repository layout
-----------------
```
cmd/api/                - application entrypoint (main.go)
internal/handlers/      - HTTP handlers (Gin)
internal/services/      - business rules
internal/repositories/  - data access (GORM)
internal/models/        - GORM models
flyway/sql/             - Flyway migrations (V1__create_tables.sql, V2__seed.sql)
docs/                   - Swagger docs generated by swag (swagger.json, swagger.yaml, docs.go)
Dockerfile              - multi-stage build
docker-compose.yml      - compose for app, db, flyway
rest.http               - example requests for REST Client (VSCode)
README.md               - this file
```

How to generate Swagger docs (swag)
----------------------------------
1. Make sure you are in the project root (where `go.mod` is located).

2. Install `swag` (if not already):
```bash
go install github.com/swaggo/swag/cmd/swag@latest
```

3. Generate docs:
```bash
swag init -g cmd/api/main.go -o docs
```

Notes:
- If swagger generation fails complaining about unknown types, adjust handler comments to reference real types defined in the code (models or response structs).
- Ensure `@Router` annotations include the full path if your runtime prefixes routes (this project uses `/api/v1`). Use `/api/v1/...` in `@Router` lines to avoid mismatch between UI and real routes.

How to build and run with Docker (recommended)
----------------------------------------------
1. Generate docs locally so `docs` exists before the image build:
```bash
swag init -g cmd/api/main.go -o docs
```

2. Build and run the stack:
```bash
docker compose up --build
```

3. If Flyway shows a checksum mismatch because migration files were edited after being applied, either:
- Repair the flyway schema history (development only):
  ```bash
  docker compose run --rm flyway repair
  ```
- Or remove volumes and recreate the entire environment (destructive):
  ```bash
  docker compose down -v
  docker compose up --build
  ```

4. Verify services:
- API: http://localhost:8080
- Swagger UI: http://localhost:8080/swagger/index.html
- Swagger JSON: http://localhost:8080/swagger/doc.json
- Health: http://localhost:8080/api/v1/health

Database: troubleshooting
-------------------------
- If Postgres container shows permission errors on `/var/lib/postgresql/data`, remove the volume and recreate:
```bash
docker compose down -v
docker compose up --build
```

- Connect to DB container for inspection:
```bash
docker exec -it company-db psql -U postgres -d companydb
# then run SQL queries like:
SELECT * FROM departamentos;
SELECT * FROM colaboradores;
```

Migrations (Flyway)
-------------------
- Flyway SQL migrations are in `flyway/sql` and are applied by the `flyway` service in `docker-compose` during startup.
- If you change an applied migration, run `docker compose run --rm flyway repair` to update the schema history checksum, or recreate the DB volume.

Swagger issues and solutions
----------------------------
Common issues when Swagger UI appears without the correct paths:
- `@Router` annotations in handlers are declared without the `/api/v1` prefix while the application registers routes under `/api/v1`. Fix by making `@Router` use `/api/v1/...` explicitly.
- `docs` folder not present in Docker image — ensure your Dockerfile copies the `docs` folder into the final image, or use `gin-swagger` (`ginSwagger.WrapHandler`) and import the generated `docs` package.

Endpoints and examples (also in rest.http)
-----------------------------------------
Base: `http://localhost:8080/api/v1`

Health
```
GET /health
```
Example:
```bash
curl http://localhost:8080/api/v1/health
```

Departamentos
```
POST   /departamentos
GET    /departamentos
GET    /departamentos/{id}
PUT    /departamentos/{id}
DELETE /departamentos/{id}
POST   /departamentos/listar   (filters in body)
```
Example create:
```bash
curl -X POST http://localhost:8080/api/v1/departamentos \
  -H "Content-Type: application/json" \
  -d '{"nome":"Financeiro","descricao":"Departamento responsável pelas finanças"}'
```

Colaboradores
```
POST   /colaboradores
GET    /colaboradores
GET    /colaboradores/{id}
PUT    /colaboradores/{id}
DELETE /colaboradores/{id}
POST   /colaboradores/listar   (filters in body)
```
Example create (uses CPF 00615075398):
```bash
curl -X POST http://localhost:8080/api/v1/colaboradores \
  -H "Content-Type: application/json" \
  -d '{"nome":"João Silva","cpf":"00615075398","rg":"PR556677","departamento_id":"018f3c3e-5c79-7b21-b7e1-d45f80cfa5ac"}'
```

Gerentes
```
GET /gerentes/{id}/colaboradores   (returns colaboradores under gerente's department hierarchy)
```
Example:
```bash
curl http://localhost:8080/api/v1/gerentes/018f3c3e-5c79-7b21-b7e1-d45f80cfa6aa/colaboradores
```

rest.http (use in VSCode REST Client)
-------------------------------------
An example `rest.http` file is included with this README in the zip package. It contains requests for all endpoints and sample payloads.

Recommended development workflow
-------------------------------
- Generate docs: `swag init -g cmd/api/main.go -o docs`
- Run `docker compose up --build`
- Inspect logs: `docker compose logs -f company-api`
- Use `rest.http` in VSCode to run requests
- If you modify migrations, use Flyway `repair` or recreate volumes

Notes about Swagger UI title/description
---------------------------------------
If you want the Swagger UI page to show a project description instead of generic wording, ensure `cmd/api/main.go` contains the API metadata comments at the top (these are used by `swag` to populate swagger.json). Example header in `main.go`:
```go
// @title Company API
// @version 1.0
// @description API para gerenciar colaboradores e departamentos
// @host localhost:8080
// @BasePath /api/v1
```

If the UI shows an empty area where description should appear, regenerate docs with `swag init` after updating the header comments and verify `docs/swagger.json` contains the `info.description` field.

License
-------
MIT (or choose your preferred license)